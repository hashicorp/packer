# appveyor.yml reference : http://www.appveyor.com/docs/appveyor-yml
# and https://github.com/unicorn-engine/unicorn/blob/master/.appveyor.yml

version: "{build}"

skip_tags: true

branches:
  only:
    - master

environment:
  GOPATH: c:\gopath
  CYG_MIRROR: http://cygwin.mirror.constant.com
  CYG_PACKAGES: make
  matrix:
  - APPVEYOR_BUILD_SYS: Cygwin
    CYG_ROOT: C:\cygwin64
    CYG_CACHE: C:\cygwin64\var\cache\setup
    CYG_SETUP: setup-x86_64.exe
    BASH: C:\cygwin64\bin\bash
  # - APPVEYOR_BUILD_SYS: Cygwin
  #   CYG_ROOT: C:\cygwin
  #   CYG_CACHE: C:\cygwin\var\cache\setup
  #   CYG_SETUP: setup-x86.exe
  #   BASH: C:\cygwin\bin\bash

init:
  # Carriage returns are bad
  - cmd:
      'git config --global core.autocrlf input'

# Cache Cygwin files to speed up build
cache:
    - '%CYG_CACHE%'

clone_folder: c:\gopath\src\github.com\hashicorp\packer

# Install needed build dependencies
install:
  - curl -fsS -o %CYG_SETUP% "https://cygwin.com/%CYG_SETUP%"
  - '%CYG_SETUP% --quiet-mode --no-shortcuts --only-site --root "%CYG_ROOT%" --site "%CYG_MIRROR%" --local-package-dir "%CYG_CACHE%" --packages "%CYG_PACKAGES%" --upgrade-also'
  - echo %Path%
  - go version
  - go env

build_script:
  - git rev-parse HEAD
  - '%BASH% -lc "pwd"'
  - '%BASH% -lc "cd $APPVEYOR_BUILD_FOLDER"'
  - '%BASH% -lc "pwd"'
  - '%BASH% -lc "cat Makefile"'
  - '%BASH% -lc "make --version"'
  - '%BASH% -lc "make deps"'

test_script:
  - '%BASH% -lc "make ci"'

deploy: off
