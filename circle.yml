machine:
  environment:
    GOPATH: "/home/ubuntu/.go_workspace"

dependencies:
  pre:
    - go get github.com/mitchellh/gox
    - gox -osarch=linux/amd64 -build-toolchain

    - go get -d github.com/mitchellh/packer
    - sed -i '/VersionPrerelease/ s/""/"dev"/' $GOPATH/src/github.com/mitchellh/packer/version.go

    - go get -u github.com/MSOpenTech/packer-azure/...

  override:
    - cd $GOPATH/src/github.com/mitchellh/packer && make dev
    - cd $GOPATH/src/github.com/MSOpenTech/packer-azure && go get -u ./... && go install -tags 'restapi' ./...

  post:
    - tar -czvf $CIRCLE_ARTIFACTS/packer.tgz -C  $GOPATH/bin $(find $GOPATH/bin -name packer\* -printf '%P ')

test:
  override:
    - /bin/true
