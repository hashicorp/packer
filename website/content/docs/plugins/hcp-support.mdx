---
description: |
  The HCP Packer support allows plugins to be used with HCP and push metadata to the HCP Packer registry.
page_title: Integration Program
---

# HCP Packer Support

~> **Note:** HCP Packer is under active development, and we suggest plugin maintainers to keep up with the SDK changes
for more on HCP Packer support.

~> **Note:** If you're looking to develop a new plugin, please refer first to the [developing
plugins](/docs/plugins/creation#developing-plugins) page.

The HCP Packer support consists on making the Image metadata available to Packer through the builder artifact. Before pushing
metadata to the HCP Packer registry, Packer will query for the Image metadata by looking for a [Image](https://github.com/hashicorp/packer-plugin-sdk/blob/b688c9db722f8e9685310b03ebcc55bfa6b7a674/packer/registry/image/image.go#L22)
under a [key](https://github.com/hashicorp/packer-plugin-sdk/blob/b688c9db722f8e9685310b03ebcc55bfa6b7a674/packer/registry/image/image.go#L15)
in the artifact.

## Builder Artifact

To make the plugin support HCP Packer, changes must be made to the build artifact. The artifact should return the appropriate
Image metadata in `State(name string) interface{}` when the `name` is the `par.artifact.metadata` specific key.

The packer-plugin-sdk implements the Image struct to make HCP Packer support easier.
We provide the [`FromArtifact`](https://github.com/hashicorp/packer-plugin-sdk/blob/efe3f1229c88b517e236b06e927b0dba7dd9394e/packer/registry/image/image.go#L96) function
to easily create an Image with the basic information contained in the Artifact. If customization is necessary, the `FromArtifact` accepts
override functions as the second argument, and that can be used to set different values for the metadata.

The [Image metadata](https://github.com/hashicorp/packer-plugin-sdk/blob/b688c9db722f8e9685310b03ebcc55bfa6b7a674/packer/registry/image/image.go#L22) structure is:
```golang

// Image represents the metadata for some Artifact in the HCP Packer Registry.
type Image struct {
	// ImageID is a unique reference identifier stored on the HCP Packer registry
	// that can be used to get back the built artifact of a builder or post-processor.
	ImageID string
	// ProviderName represents the name of the top level cloud or service where the built artifact resides.
	// For example "aws, azure, docker, gcp, and vsphere".
	ProviderName string
	// ProviderRegion represents the location of the built artifact.
	// For cloud providers region usually maps to a cloud region or zone, but for things like the file builder,
	// S3 bucket or vsphere cluster region can represent a path on the upstream datastore, or cluster.
	ProviderRegion string
	// Labels represents additional details about an image that a builder or post-processor may with to provide for a given build.
	// Any additional metadata will be made available as build labels within a HCP Packer registry iteration.
	Labels map[string]string
	// SourceImageID is the cloud image id of the image that was used as the
	// source for this image. If set, the HCP Packer registry will be able
	// link the parent and child images for ancestry visualizations and
	// dependency tracking.
	SourceImageID string
}
```

Where `ImageID`, `ProviderName`, and `SourceImageID` are mandatory fields.

Examples using the `FromArtifact` method:

- Simple form:
```golang
func (a *Artifact) State(name string) interface{} {
	if name == registryimage.ArtifactStateURI {
		img, err := registryimage.FromArtifact(a)
		if err != nil {
			log.Printf("[DEBUG] error encountered when creating a registry image %v", err)
			return nil
		}
	  return img
	}
	return a.StateData[name]
}
```

- Using overrides:
```golang
func (a *Artifact) State(name string) interface{} {
	if name == registryimage.ArtifactStateURI {
		img, err := registryimage.FromArtifact(a,
                registryimage.WithID(a.Name),
                registryimage.WithRegion(a.Region.Name()),
                registryimage.WithProvider("happy-cloud"),
                registryimage.WithSourceID(a.SourceID),
                registryimage.SetLabels(a.Labels),
              )
		if err != nil {
			log.Printf("[DEBUG] error encountered when creating a registry image %v", err)
			return nil
		}
	  return img
	}
	return a.StateData[name]
}
```

### SDK Version

- The HCP Packer support is available from packer-plugin-sdk >= v0.2.7

## Plugins Example

The following plugins currently support HCP Packer and are great references for development:

- [packer-plugin-amazon](https://github.com/hashicorp/packer-plugin-amazon)
- [packer-plugin-azure](https://github.com/hashicorp/packer-plugin-azure)
- [packer-plugin-vsphere](https://github.com/hashicorp/packer-plugin-vsphere)
- [packer-plugin-docker](https://github.com/hashicorp/packer-plugin-docker)
- [packer-plugin-googlecompute](https://github.com/hashicorp/packer-plugin-googlecompute)

## HCP Packer

To get to know HCP Packer, visit the
[HCP Packer documentation](https://cloud.hashicorp.com/docs/packer) or try the
[Get Started with HCP Packer](https://learn.hashicorp.com/collections/packer/hcp-get-started)
collection on HashiCorp Learn.
